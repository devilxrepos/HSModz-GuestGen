<!DOCTYPE html>
<html>
<head>
    <title>Admin Panel | Free Fire Generator</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            background: #0f172a; 
            color: white; 
            margin: 0;
            padding: 20px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #334155;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .card {
            background: #020617;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            border: 1px solid #334155;
        }
        h1, h2, h3 {
            color: #22c55e;
            margin-top: 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th {
            background: #1e293b;
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid #334155;
        }
        td {
            padding: 12px;
            border-bottom: 1px solid #334155;
        }
        tr:hover {
            background: rgba(30, 41, 59, 0.5);
        }
        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .badge-active {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }
        .badge-inactive {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin: 0 5px;
            transition: opacity 0.3s;
        }
        .btn:hover {
            opacity: 0.9;
        }
        .btn-toggle {
            background: #3b82f6;
            color: white;
        }
        .btn-delete {
            background: #ef4444;
            color: white;
        }
        .btn-logout {
            background: #dc2626;
            color: white;
        }
        .form-group {
            margin-bottom: 15px;
        }
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #334155;
            border-radius: 6px;
            background: #1e293b;
            color: white;
            box-sizing: border-box;
        }
        .btn-create {
            background: #22c55e;
            color: white;
            padding: 12px 24px;
            width: 100%;
            font-size: 16px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background: #1e293b;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
        }
        .stat-label {
            color: #94a3b8;
            font-size: 14px;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: #020617;
            padding: 30px;
            border-radius: 10px;
            width: 400px;
            max-width: 90%;
            border: 1px solid #22c55e;
        }
        .license-details {
            background: rgba(30, 41, 59, 0.5);
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            font-family: monospace;
            word-break: break-all;
        }
        .search-box {
            margin: 20px 0;
        }
        .search-input {
            width: 300px;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #334155;
            background: #1e293b;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öôÔ∏è Admin Control Panel</h1>
            <div>
                <a href="/admin/panel" style="color: #22c55e; margin-right: 20px;">Dashboard</a>
                <button class="btn btn-logout" onclick="location.href='/logout'">Logout</button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalLicenses">{{ licenses|length }}</div>
                <div class="stat-label">Total Licenses</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="activeLicenses">0</div>
                <div class="stat-label">Active Licenses</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalAccounts">0</div>
                <div class="stat-label">Accounts Generated</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="expiredLicenses">0</div>
                <div class="stat-label">Expired Licenses</div>
            </div>
        </div>

        <div class="card">
            <h2>üìù Create New License</h2>
            <form id="createLicenseForm">
                <div class="form-group">
                    <input type="text" id="username" placeholder="Username *" required>
                </div>
                <div class="form-group">
                    <input type="email" id="email" placeholder="Email Address">
                </div>
                <div class="form-group">
                    <input type="number" id="days" placeholder="Validity Days (default: 30)" min="1" max="365">
                </div>
                <div class="form-group">
                    <input type="number" id="maxAccounts" placeholder="Max Accounts (default: 1000)" min="1" max="10000">
                </div>
                <button type="submit" class="btn btn-create">Generate License</button>
            </form>
            <div id="createResult" style="margin-top: 15px;"></div>
        </div>

        <div class="card">
            <div class="search-box">
                <input type="text" class="search-input" placeholder="Search licenses..." onkeyup="filterLicenses(this.value)">
            </div>
            <h2>üìã License Management</h2>
            <table id="licensesTable">
                <thead>
                    <tr>
                        <th>License Key</th>
                        <th>Username</th>
                        <th>Status</th>
                        <th>Generated</th>
                        <th>Expires</th>
                        <th>Accounts</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key, license in licenses.items() %}
                    <tr>
                        <td>{{ key[:15] }}...</td>
                        <td>{{ license.username }}</td>
                        <td>
                            <span class="badge {% if license.is_active %}badge-active{% else %}badge-inactive{% endif %}">
                                {{ 'ACTIVE' if license.is_active else 'INACTIVE' }}
                            </span>
                        </td>
                        <td>{{ license.created_at[:10] }}</td>
                        <td>{{ license.expires_at[:10] }}</td>
                        <td>{{ license.generated_accounts or 0 }}/{{ license.max_accounts or 1000 }}</td>
                        <td>
                            <button class="btn btn-toggle" onclick="toggleLicense('{{ key }}')">
                                {{ 'Deactivate' if license.is_active else 'Activate' }}
                            </button>
                            <button class="btn btn-delete" onclick="deleteLicense('{{ key }}')">Delete</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div id="licenseModal" class="modal">
        <div class="modal-content">
            <h2>üìã License Details</h2>
            <div class="license-details" id="modalLicenseDetails"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="copyLicenseDetails()" style="background: #3b82f6; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer;">Copy Details</button>
                <button onclick="closeModal()" style="background: #64748b; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; margin-left: 10px;">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Calculate stats
        function calculateStats() {
            const licenses = {{ licenses|tojson }};
            let activeCount = 0;
            let expiredCount = 0;
            let totalAccounts = 0;
            
            Object.values(licenses).forEach(license => {
                if (license.is_active !== false) {
                    activeCount++;
                }
                if (new Date(license.expires_at) < new Date()) {
                    expiredCount++;
                }
                totalAccounts += license.generated_accounts || 0;
            });
            
            document.getElementById('activeLicenses').textContent = activeCount;
            document.getElementById('totalAccounts').textContent = totalAccounts;
            document.getElementById('expiredLicenses').textContent = expiredCount;
        }
        
        calculateStats();

        // Create license form
        document.getElementById('createLicenseForm').onsubmit = async (e) => {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('username', document.getElementById('username').value);
            formData.append('email', document.getElementById('email').value);
            formData.append('days', document.getElementById('days').value);
            formData.append('max_accounts', document.getElementById('maxAccounts').value);
            
            try {
                const response = await fetch('/admin/create_license', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                const resultDiv = document.getElementById('createResult');
                
                if (data.status === 'success') {
                    resultDiv.innerHTML = `<div style="color: #22c55e; padding: 10px; background: rgba(34, 197, 94, 0.1); border-radius: 6px;">
                        ‚úÖ License created successfully!<br>
                        License Key: <strong>${data.license_key}</strong><br>
                        <button onclick="showLicenseDetails('${data.license_key}')" style="background: #3b82f6; color: white; border: none; padding: 5px 10px; border-radius: 4px; margin-top: 10px; cursor: pointer;">View Details</button>
                    </div>`;
                    
                    // Clear form
                    document.getElementById('createLicenseForm').reset();
                    
                    // Reload page after 2 seconds to show new license
                    setTimeout(() => location.reload(), 2000);
                } else {
                    resultDiv.innerHTML = `<div style="color: #ef4444; padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 6px;">
                        ‚ùå Error: ${data.message}
                    </div>`;
                }
            } catch (error) {
                document.getElementById('createResult').innerHTML = `<div style="color: #ef4444;">
                    Network error: ${error.message}
                </div>`;
            }
        };

        async function toggleLicense(licenseKey) {
            if (!confirm('Are you sure you want to toggle this license?')) return;
            
            try {
                const response = await fetch(`/admin/toggle_license/${licenseKey}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                if (data.status === 'success') {
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                alert('Network error: ' + error.message);
            }
        }

        async function deleteLicense(licenseKey) {
            if (!confirm('Are you sure you want to delete this license? This cannot be undone.')) return;
            
            try {
                const response = await fetch(`/admin/delete_license/${licenseKey}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                if (data.status === 'success') {
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                alert('Network error: ' + error.message);
            }
        }

        function filterLicenses(searchText) {
            const table = document.getElementById('licensesTable');
            const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
            
            for (let row of rows) {
                const cells = row.getElementsByTagName('td');
                let match = false;
                
                for (let cell of cells) {
                    if (cell.textContent.toLowerCase().includes(searchText.toLowerCase())) {
                        match = true;
                        break;
                    }
                }
                
                row.style.display = match ? '' : 'none';
            }
        }

        function showLicenseDetails(licenseKey) {
            const licenses = {{ licenses|tojson }};
            const license = licenses[licenseKey];
            
            if (!license) return;
            
            let details = `License Key: ${licenseKey}\n\n`;
            details += `Username: ${license.username}\n`;
            details += `Email: ${license.email || 'N/A'}\n`;
            details += `Created: ${license.created_at}\n`;
            details += `Expires: ${license.expires_at}\n`;
            details += `Status: ${license.is_active ? 'ACTIVE' : 'INACTIVE'}\n`;
            details += `Generated Accounts: ${license.generated_accounts || 0}\n`;
            details += `Max Accounts: ${license.max_accounts || 1000}\n`;
            details += `Usage Count: ${license.usage_count || 0}\n`;
            details += `Last Used: ${license.last_used || 'Never'}`;
            
            document.getElementById('modalLicenseDetails').textContent = details;
            document.getElementById('licenseModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('licenseModal').style.display = 'none';
        }

        function copyLicenseDetails() {
            const details = document.getElementById('modalLicenseDetails').textContent;
            navigator.clipboard.writeText(details).then(() => {
                alert('License details copied to clipboard!');
            });
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('licenseModal');
            if (event.target === modal) {
                closeModal();
            }
        };
    </script>
</body>
</html>